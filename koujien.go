package yomichan

import (
	"regexp"
	"strings"

	zig "foosoft.net/projects/zero-epwing-go"
)

type koujienExtractor struct {
	partsExp     *regexp.Regexp
	readGroupExp *regexp.Regexp
	expVarExp    *regexp.Regexp
	metaExp      *regexp.Regexp
	v5Exp        *regexp.Regexp
	v1Exp        *regexp.Regexp
}

func makeKoujienExtractor() epwingExtractor {
	return &koujienExtractor{
		partsExp:     regexp.MustCompile(`([^ï¼ˆã€ã€–]+)(?:ã€(.*)ã€‘)?(?:ã€–(.*)ã€—)?(?:ï¼ˆ(.*)ï¼‰)?`),
		readGroupExp: regexp.MustCompile(`[â€ãƒ»]+`),
		expVarExp:    regexp.MustCompile(`\(([^\)]*)\)`),
		metaExp:      regexp.MustCompile(`ï¼ˆ([^ï¼‰]*)ï¼‰`),
		v5Exp:        regexp.MustCompile(`(å‹•.[å››äº”](ï¼»[^ï¼½]+ï¼½)?)|(å‹•..äºŒ)`),
		v1Exp:        regexp.MustCompile(`(å‹•..ä¸€)`),
	}
}
func makeFuzokuExtractor() epwingExtractor {
	return &koujienExtractor{
		partsExp:     regexp.MustCompile(`([^ï¼ˆã€ã€–]+)(?:ã€(.*)ã€‘)?(?:ã€–(.*)ã€—)?(?:ï¼ˆ(.*)ï¼‰)?`),
		readGroupExp: regexp.MustCompile(`[-ãƒ»]+`),
		expVarExp:    regexp.MustCompile(`\(([^\)]*)\)`),
		metaExp:      regexp.MustCompile(`ï¼ˆ([^ï¼‰]*)ï¼‰`),
		v5Exp:        regexp.MustCompile(`(å‹•.[å››äº”](ï¼»[^ï¼½]+ï¼½)?)|(å‹•..äºŒ)`),
		v1Exp:        regexp.MustCompile(`(å‹•..ä¸€)`),
	}
}

func (e *koujienExtractor) extractTerms(entry zig.BookEntry, sequence int) []dbTerm {
	matches := e.partsExp.FindStringSubmatch(entry.Heading)
	if matches == nil {
		return nil
	}

	var expressions, readings []string
	if expression := matches[2]; len(expression) > 0 {
		expression = e.metaExp.ReplaceAllLiteralString(expression, "")
		for _, split := range strings.Split(expression, "ãƒ»") {
			splitInc := e.expVarExp.ReplaceAllString(split, "$1")
			expressions = append(expressions, splitInc)
			if split != splitInc {
				splitExc := e.expVarExp.ReplaceAllLiteralString(split, "")
				expressions = append(expressions, splitExc)
			}
		}
	}

	if reading := matches[1]; len(reading) > 0 {
		reading = e.readGroupExp.ReplaceAllLiteralString(reading, "")
		readings = append(readings, reading)
	}

	var tags []string
	for _, split := range strings.Split(entry.Text, "\n") {
		if matches := e.metaExp.FindStringSubmatch(split); matches != nil {
			for _, tag := range strings.Split(matches[1], "ãƒ»") {
				tags = append(tags, tag)
			}
		}
	}

	var terms []dbTerm
	if len(expressions) == 0 {
		for _, reading := range readings {
			term := dbTerm{
				Expression: reading,
				Glossary:   []any{entry.Text},
				Sequence:   sequence,
			}

			e.exportRules(&term, tags)
			terms = append(terms, term)
		}

	} else {
		for _, expression := range expressions {
			for _, reading := range readings {
				term := dbTerm{
					Expression: expression,
					Reading:    reading,
					Glossary:   []any{entry.Text},
					Sequence:   sequence,
				}

				e.exportRules(&term, tags)
				terms = append(terms, term)
			}
		}
	}

	return terms
}

func (*koujienExtractor) extractKanji(entry zig.BookEntry) []dbKanji {
	return nil
}

func (e *koujienExtractor) exportRules(term *dbTerm, tags []string) {
	for _, tag := range tags {
		if tag == "å½¢" {
			term.addRules("adj-i")
		} else if tag == "å‹•ã‚µå¤‰" && (strings.HasSuffix(term.Expression, "ã™ã‚‹") || strings.HasSuffix(term.Expression, "ç‚ºã‚‹")) {
			term.addRules("vs")
		} else if term.Expression == "æ¥ã‚‹" {
			term.addRules("vk")
		} else if e.v5Exp.MatchString(tag) {
			term.addRules("v5")
		} else if e.v1Exp.MatchString(tag) {
			term.addRules("v1")
		}
	}
}

func (*koujienExtractor) getRevision() string {
	return "koujien2"
}

func (*koujienExtractor) getFontNarrow() map[int]string {
	return map[int]string{
		41249: "Ã¡",
		41250: "Ã ",
		41251: "Ã¢",
		41252: "Ã¤",
		41253: "Ã£",
		41254: "Ä",
		41256: "Ä‡",
		41258: "dÌ£",
		41259: "Ã©",
		41260: "Ã¨",
		41261: "Ãª",
		41262: "Ã«",
		41263: "Ä“",
		41265: "hÌ£",
		41266: "Ã­",
		41268: "Ã¯",
		41269: "Ä«",
		41271: "mÌ£",
		41273: "Ã±",
		41274: "nÌ‡",
		41275: "nÌ£",
		41276: "Ã³",
		41279: "Ã¶",
		41281: "Å",
		41282: "Å",
		41283: "rÌ£",
		41285: "Å›",
		41286: "sÌ£",
		41288: "á¹­",
		41289: "Ãº",
		41291: "Ã¼",
		41292: "Å«",
		41293: "Å­",
		41294: "Ã¿",
		41295: "Åº",
		41296: "zÌ£",
		41301: "Ã§",
		41303: "â€˜",
		41310: "Ë",
		41311: "Å‚",
		41313: "É”",
		41314: "Ã¸",
		41329: "Ã",
		41331: "Ã–",
		41334: "Ãœ",
		41335: "Ä€",
		41339: "Å",
		41340: "Ã†",
		41342: "Ã‰",
		41505: "Ã„",
		41506: "Åš",
		41507: "Äª",
		41508: "Ã…",
		41515: "ÅŒ",
		41518: "Ä™",
		41521: "ZÌ£",
		41522: "HÌ£",
		41523: "RÌ£",
		41524: "SÌ£",
		41531: "âŸ¨",
		41532: "âŸ©",
		41542: "Ä’",
		41576: "Ã‡",
		41767: "Ä°",
	}
}

func (*koujienExtractor) getFontWide() map[int]string {
	return map[int]string{
		41506: "Åš",
		42017: "â‡¿",
		42018: "ğŸˆ‘",
		42019: "1",
		42021: "2",
		42023: "ãŠ€",
		42024: "ãŠ",
		42026: "3",
		42027: "â·",
		42028: "â¶",
		42029: "ã€µ",
		42030: "ã€³",
		42031: "â¸",
		42034: "4",
		42035: "è’´",
		42036: "ã€»",
		42037: "â¹",
		42038: "5",
		42040: "ğ£‘¥",
		42041: "æ˜",
		42043: "âº",
		42044: "6",
		42045: "â»",
		42046: "æ£°",
		42047: "æ ¬",
		42048: "7",
		42052: "ãŠ‚",
		42053: "åœ",
		42054: "æ¡›",
		42055: "ç³",
		42056: "ä½¾",
		42057: "â¼",
		42058: "åŸµ",
		42061: "æŒµ",
		42063: "ç™­",
		42065: "é–©",
		42067: "çª ",
		42069: "é‰¸",
		42071: "è‹†",
		42072: "çº",
		42073: "ç°¶",
		42074: "é‚Œ",
		42075: "å£”",
		42079: "èœ±",
		42080: "é¡—",
		42081: "æ„·",
		42083: "â½",
		42084: "é¸•",
		42086: "æ°",
		42089: "å£’",
		42092: "éµ¼",
		42093: "ç©­",
		42095: "è§",
		42097: "ç·‚",
		42098: "é–¦",
		42100: "è‰ ",
		42101: "ç±­",
		42102: "ç¸‘",
		42105: "ç©€",
		42108: "é±",
		42109: "éˆ¹",
		42273: "è ƒ",
		42274: "å™¶",
		42275: "é‚•",
		42277: "æ†",
		42279: "ç‚»",
		42281: "ç…†",
		42282: "è¤š",
		42284: "â¾",
		42285: "å„ˆ",
		42286: "ç‚·",
		42287: "å’©",
		42288: "ç²”",
		42289: "ç±¹",
		42292: "é‚ˆ",
		42293: "éº½",
		42297: "éº",
		42298: "æ®­",
		42300: "è˜",
		42301: "è”",
		42309: "æƒ²",
		42311: "ç™‹",
		42312: "ç´‡",
		42313: "çµ",
		42314: "é",
		42315: "æ»",
		42316: "å„›",
		42317: "æ«§",
		42318: "æ©…",
		42319: "è±¨",
		42320: "å©•",
		42322: "å¦¤",
		42323: "ç… ",
		42324: "é‹‚",
		42325: "èœ“",
		42326: "è¢˜",
		42329: "é´—",
		42332: "å”µ",
		42333: "å¢©",
		42336: "æŸƒ",
		42338: "æ¸²",
		42339: "æ³”",
		42341: "è‡",
		42342: "ç‰",
		42343: "è­",
		42344: "è•™",
		42346: "è˜",
		42347: "æ£­",
		42348: "æœ³",
		42349: "å°°",
		42350: "è³¾",
		42351: "ç«½",
		42352: "è£›",
		42353: "å­",
		42354: "é—ˆ",
		42356: "ç°",
		42358: "ç®¯",
		42360: "è²",
		42364: "é—",
		42365: "é¾—",
		42366: "å­½",
		42529: "éŸ›",
		42531: "ç“«",
		42532: "å¡¼",
		42533: "é„§",
		42535: "æˆ",
		42537: "ç·Œ",
		42538: "é¡¬",
		42540: "éŠ™",
		42542: "é ",
		42544: "â¿",
		42546: "ğ¦¨",
		42549: "ä³‘",
		42551: "è—¿",
		42552: "ç’«",
		42553: "ç¨¹",
		42554: "è·—",
		42555: "ç¸•",
		42556: "å¹˜",
		42557: "ç¹’",
		42558: "è ",
		42561: "é‰",
		42563: "é‚¶",
		42568: "8",
		42569: "æ¨",
		42571: "æª",
		42572: "æ˜º",
		42574: "é˜",
		42578: "ç¹‡",
		42579: "å¹",
		42582: "è•¤",
		42583: "ç—¤",
		42584: "è…Š",
		42587: "ç™¤",
		42588: "ç“š",
		42591: "ç†’",
		42592: "é±“",
		42593: "æ«²",
		42595: "æˆ•",
		42599: "èšœ",
		42600: "å¬¥",
		42601: "ç¦",
		42602: "å§’",
		42605: "å¥­",
		42606: "é­£",
		42608: "å¾§",
		42609: "è—¦",
		42611: "æ“",
		42612: "éº¯",
		42613: "æ»ƒ",
		42619: "ç¡¨",
		42620: "ç£²",
		42621: "éš",
		42785: "ç–¿",
		42787: "å“",
		42791: "å€»",
		42792: "ç‡„",
		42793: "å’",
		42795: "å¼‡",
		42796: "åŸ¿",
		42798: "æ©",
		42799: "æ½™",
		42800: "ç¤",
		42804: "æŒ¹",
		42805: "èŠ",
		42811: "ç›Œ",
		42820: "ğ©Š±",
		42823: "å¼´",
		42826: "å’¿",
		42828: "æ¥‰",
		42831: "é‘¯",
		42833: "ç¡®",
		42836: "çŸ",
		42837: "ç ­",
		42838: "é¶",
		42839: "å™¯",
		42842: "ç³•",
		42844: "é´²",
		42846: "è—‹",
		42847: "å¶ ",
		42848: "é¼¯",
		42851: "æ¢²",
		42856: "æ­†",
		42862: "çŸª",
		42863: "èºƒ",
		42866: "é¯¥",
		42868: "èŠ·",
		42871: "ç³ˆ",
		42873: "é¬ ",
		42876: "é±",
		43048: "ç³—",
		43053: "ç”ª",
		43057: "å‰¡",
		43058: "ã€½",
		43061: "åŸ¦",
		43062: "å¸”",
		43065: "æ¶ª",
		43076: "ç‰",
		43078: "æª",
		43080: "å§§",
		43081: "ğ¤¸",
		43085: "ç­ ",
		43086: "é­¦",
		43088: "å‰•",
		43099: "éµ‚",
		43104: "ç‘­",
		43106: "å–",
		43107: "å ",
		43108: "ä½·",
		43109: "ç¹³",
		43110: "ç†…",
		43111: "æ¢‚",
		43112: "æ–²",
		43113: "ç—Ÿ",
		43114: "å…—",
		43118: "æ¦º",
		43119: "å„‹",
		43120: "æ©‰",
		43121: "é±",
		43124: "è’º",
		43128: "èˆ",
		43131: "ã¡œ",
		43133: "è‡",
		43134: "é·š",
		43297: "é›",
		43300: "å”¼",
		43301: "å ˆ",
		43306: "æ°…",
		43309: "ç­•",
		43310: "ç¯–",
		43317: "ç£¤",
		43320: "å“",
		43321: "é‘Š",
		43325: "æ»‡",
		43327: "ç—€",
		43330: "ç¬¯",
		43336: "9",
		43342: "è©",
		43345: "çŒ¬",
		43346: "ğ¨«¤",
		43349: "è•“",
		43352: "å½‡",
		43354: "è‚«",
		43356: "ç‰–",
		43370: "åˆ",
		43381: "æ¼³",
		43385: "æ’‡",
		43386: "æ¿Š",
		43387: "è“¯",
		43390: "å¸",
		43556: "ç˜€",
		43557: "æ§©",
		43568: "é–’",
		43575: "ç‰±",
		43582: "è›º",
		43583: "è´‰",
		43588: "é–",
		43593: "é‘£",
		43594: "å „",
		43595: "èœ",
		43603: "å˜·",
		43607: "ãŠƒ",
		43611: "â“«",
		43612: "â“¬",
		43614: "çŒ¨",
		43620: "ç¬",
		43622: "è¶",
		43623: "ä¸¨",
		43627: "æ½",
		43628: "æ™³",
		43635: "é†…",
		43636: "é†",
		43637: "é†®",
		43638: "è¸ ",
		43641: "ç³",
		43643: "å‘«",
		43644: "é½­",
		43645: "æ¥²",
		43809: "é±",
		43810: "é®§",
		43811: "åŸ¤",
		43818: "é±®",
		43821: "æ¥¨",
		43822: "è”¾",
		43824: "è ",
		43825: "è·",
		43826: "ç†›",
		43827: "è²›",
		43829: "é±›",
		43830: "ç•",
		43831: "ç¦›",
		43837: "ç¿®",
		43838: "é¯‡",
		43839: "çŠ°",
		43840: "ç‹³",
		43842: "å‘",
		43843: "åšˆ",
		43845: "é­",
		43846: "å™ ",
		43848: "èš¨",
		43849: "é·€",
		43850: "åˆ–",
		43851: "è±",
		43854: "çª³",
		43855: "ç²¿",
		43860: "è³–",
		43870: "è—Š",
		43876: "ç¿¬",
		43883: "æš",
		43886: "é «",
		43889: "è€",
		43899: "â•",
		44071: "çƒ¤",
		44073: "æ˜€",
		44079: "é½µ",
		44093: "è¥€",
		44100: "â–¬",
		44101: "é˜",
		44102: "ä¹š",
		44113: "ç½’",
		44121: "å¬™",
		44125: "é¥œ",
		44127: "å‡Š",
		44131: "æ•§",
		44138: "å¯€",
		44142: "ğ‘–€",
		44144: "è§¶",
		44321: "èŠ¡",
		44330: "é°§",
		44332: "è”¯",
		44334: "è‘ˆ",
		44351: "ç•¯",
		44353: "çŒ",
		44355: "è©ƒ",
		44378: "ç",
		44399: "ç›¹",
		44412: "é†ƒ",
		44579: "ç¯¨",
		44583: "éœ‚",
		44586: "ç±§",
		44587: "èœ¹",
		44613: "è¶¯",
		44620: "è¼",
		44626: "å–†",
		44628: "é§",
		44632: "é›©",
		44650: "é§”",
		44652: "é©Œ",
		44658: "éŒ¡",
		44661: "é¶¹",
		44669: "é®",
		44856: "ã‰‘",
		44857: "ã‰’",
		44872: "è€¬",
		44902: "è·¬",
		44905: "è¹¢",
		44906: "è¹»",
		44909: "æ »",
		44910: "ç…¨",
		44919: "ç ",
		44922: "å˜½",
		44923: "ç¯…",
		44924: "ğ¥«¥",
		45089: "çŸ°",
		45091: "è„¬",
		45092: "ç®„",
		45094: "é¼¿",
		45095: "è„°",
		45096: "è‘™",
		45097: "è¤",
		45101: "æ¸ ",
		45117: "ç‰«",
		45120: "ã­¬",
		45127: "æ€",
		45132: "ä²‘",
		45137: "åš…",
		45139: "é¯˜",
		45140: "å¨Œ",
		45149: "è—›",
		45163: "æ¤±",
		45166: "èµ",
		45171: "ç¦",
		45176: "ç‰•",
		45181: "ç˜‡",
		45182: "å¹",
		45350: "æ£ˆ",
		45351: "é±",
		45360: "ç‘‡",
		45361: "ä¹€",
		45363: "æ¡•",
		45365: "è›¿",
		45366: "ç›¬",
		45367: "é¸",
		45368: "å°«",
		45369: "ç°¦",
		45370: "ç¿¨",
		45371: "ç¦‹",
		45382: "è•",
		45389: "ğ©ºŠ",
		45391: "å‹–",
		45392: "ç’¡",
		45393: "ç’©",
		45395: "æ»",
		45397: "åª",
		45403: "è–",
		45404: "ç°„",
		45405: "ç£ ",
		45411: "é¸Š",
		45412: "é·‰",
		45413: "å§",
		45419: "å±Ÿ",
		45421: "è›‘",
		45434: "æŸ¹",
		45435: "è’",
		45436: "è—",
		45437: "ç™ƒ",
		45607: "è¤",
		45609: "é±Š",
		45615: "å…",
		45616: "æª°",
		45617: "é¤²",
		45619: "æ´¿",
		45628: "å•",
		45639: "ç¹¦",
		45640: "èª¾",
		45652: "ç",
		45670: "çŒ½",
		45674: "èš¸",
		45676: "è£“",
		45679: "èŒ›",
		45680: "é¤»",
		45692: "è˜",
		45864: "ç£ˆ",
		45865: "è˜",
		45888: "é°™",
		45889: "å",
		45890: "â™®",
		45891: "å’",
		45894: "ğ›€",
		45903: "é±©",
		45917: "é½“",
		45932: "è‡",
		45934: "é¼´",
		45946: "è˜¡",
		45948: "ç’˜",
		46117: "è‡",
		46124: "è—‚",
		46137: "é°˜",
		46161: "è€‚",
		46162: "ç‰œ",
		46163: "ã“",
		46171: "ç©´",
		46172: "â»—",
		46179: "é©“",
		46193: "é±«",
		46194: "é±œ",
		46200: "æ…¤",
		46374: "ã€”",
		46375: "ã€•",
		46384: "â€¦",
		46390: "â‘ ",
		46391: "â‘¡",
		46392: "â‘¢",
		46393: "â‘£",
		46394: "â‘¤",
		46395: "â‘¥",
		46396: "â‘¦",
		46397: "â‘§",
		46398: "â‘¨",
		46399: "â‘©",
		46400: "â‘ª",
		46401: "â‘«",
		46402: "â‘¬",
		46403: "â‘­",
		46404: "â‘®",
		46405: "â‘¯",
		46406: "â‘°",
		46407: "â‘±",
		46408: "â‘²",
		46409: "â‘³",
		46420: "â‡¨",
		46421: "â… ",
		46422: "â…¡",
		46425: "â…¢",
		46426: "â…£",
		46427: "â…®",
		46433: "ğ‘¨",
		46434: "ğ‘©",
		46435: "ç’Ÿ",
		46437: "â…¬",
		46456: "æ‹¼",
		46460: "é±",
		46626: "çŠ",
		46640: "ç¼",
		46654: "æ¶‡",
		46656: "æ½¾",
		46658: "æ³®",
		46661: "ğ¦›",
		46665: "é¯",
		46666: "ğ©·",
		46674: "ğ¦¬¸",
		46677: "â‡€",
		46920: "è¨‡",
		46956: "æ¦·",
		47166: "é«",
		47175: "(å­£)",
		47183: "â’¶",
		47200: "å±§",
		47204: "è‘’",
		47205: "èŠ©",
		47210: "é¤³",
		47212: "æ™—",
		47214: "é—“",
		47216: "è˜„",
		47223: "æ°³",
		47229: "â™¨",
		47399: "ğ ˜¨",
		47994: "åŠ„",
		50236: "éƒ‰",
		51565: "æ®",
		52288: "æ¶µ",
		52862: "æ¯—",
		55383: "é–¬",
		56383: "ã‹",
		56384: "ã‹‘",
		56385: "ã‹’",
		56386: "ã‹“",
		56387: "ã‹”",
		56388: "ã‹•",
		56389: "ã‹–",
		56390: "ã‹—",
		56391: "ã‹˜",
		56392: "ã‹™",
		56393: "ã‹š",
		56394: "ã‹›",
		56395: "ã‹œ",
		56396: "ã‹",
		56397: "ã‹",
		56398: "â–·",
		56405: "ç†",
		56417: "ç…•",
		60748: "æ¿°",
		61562: "èŸ",
	}
}
