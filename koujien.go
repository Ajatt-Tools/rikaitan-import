package yomichan

import (
	"regexp"
	"strings"

	zig "foosoft.net/projects/zero-epwing-go"
)

type koujienExtractor struct {
	partsExp     *regexp.Regexp
	readGroupExp *regexp.Regexp
	expVarExp    *regexp.Regexp
	metaExp      *regexp.Regexp
	v5Exp        *regexp.Regexp
	v1Exp        *regexp.Regexp
}

func makeKoujienExtractor() epwingExtractor {
	return &koujienExtractor{
		partsExp:     regexp.MustCompile(`([^（【〖]+)(?:【(.*)】)?(?:〖(.*)〗)?(?:（(.*)）)?`),
		readGroupExp: regexp.MustCompile(`[‐・]+`),
		expVarExp:    regexp.MustCompile(`\(([^\)]*)\)`),
		metaExp:      regexp.MustCompile(`（([^）]*)）`),
		v5Exp:        regexp.MustCompile(`(動.[四五](［[^］]+］)?)|(動..二)`),
		v1Exp:        regexp.MustCompile(`(動..一)`),
	}
}
func makeFuzokuExtractor() epwingExtractor {
	return &koujienExtractor{
		partsExp:     regexp.MustCompile(`([^（【〖]+)(?:【(.*)】)?(?:〖(.*)〗)?(?:（(.*)）)?`),
		readGroupExp: regexp.MustCompile(`[-・]+`),
		expVarExp:    regexp.MustCompile(`\(([^\)]*)\)`),
		metaExp:      regexp.MustCompile(`（([^）]*)）`),
		v5Exp:        regexp.MustCompile(`(動.[四五](［[^］]+］)?)|(動..二)`),
		v1Exp:        regexp.MustCompile(`(動..一)`),
	}
}

func (e *koujienExtractor) extractTerms(entry zig.BookEntry, sequence int) []dbTerm {
	matches := e.partsExp.FindStringSubmatch(entry.Heading)
	if matches == nil {
		return nil
	}

	var expressions, readings []string
	if expression := matches[2]; len(expression) > 0 {
		expression = e.metaExp.ReplaceAllLiteralString(expression, "")
		for _, split := range strings.Split(expression, "・") {
			splitInc := e.expVarExp.ReplaceAllString(split, "$1")
			expressions = append(expressions, splitInc)
			if split != splitInc {
				splitExc := e.expVarExp.ReplaceAllLiteralString(split, "")
				expressions = append(expressions, splitExc)
			}
		}
	}

	if reading := matches[1]; len(reading) > 0 {
		reading = e.readGroupExp.ReplaceAllLiteralString(reading, "")
		readings = append(readings, reading)
	}

	var tags []string
	for _, split := range strings.Split(entry.Text, "\n") {
		if matches := e.metaExp.FindStringSubmatch(split); matches != nil {
			for _, tag := range strings.Split(matches[1], "・") {
				tags = append(tags, tag)
			}
		}
	}

	var terms []dbTerm
	if len(expressions) == 0 {
		for _, reading := range readings {
			term := dbTerm{
				Expression: reading,
				Glossary:   []any{entry.Text},
				Sequence:   sequence,
			}

			e.exportRules(&term, tags)
			terms = append(terms, term)
		}

	} else {
		for _, expression := range expressions {
			for _, reading := range readings {
				term := dbTerm{
					Expression: expression,
					Reading:    reading,
					Glossary:   []any{entry.Text},
					Sequence:   sequence,
				}

				e.exportRules(&term, tags)
				terms = append(terms, term)
			}
		}
	}

	return terms
}

func (*koujienExtractor) extractKanji(entry zig.BookEntry) []dbKanji {
	return nil
}

func (e *koujienExtractor) exportRules(term *dbTerm, tags []string) {
	for _, tag := range tags {
		if tag == "形" {
			term.addRules("adj-i")
		} else if tag == "動サ変" && (strings.HasSuffix(term.Expression, "する") || strings.HasSuffix(term.Expression, "為る")) {
			term.addRules("vs")
		} else if term.Expression == "来る" {
			term.addRules("vk")
		} else if e.v5Exp.MatchString(tag) {
			term.addRules("v5")
		} else if e.v1Exp.MatchString(tag) {
			term.addRules("v1")
		}
	}
}

func (*koujienExtractor) getRevision() string {
	return "koujien2"
}

func (*koujienExtractor) getFontNarrow() map[int]string {
	return map[int]string{
		41249: "á",
		41250: "à",
		41251: "â",
		41252: "ä",
		41253: "ã",
		41254: "ā",
		41256: "ć",
		41258: "ḍ",
		41259: "é",
		41260: "è",
		41261: "ê",
		41262: "ë",
		41263: "ē",
		41265: "ḥ",
		41266: "í",
		41268: "ï",
		41269: "ī",
		41271: "ṃ",
		41273: "ñ",
		41274: "ṅ",
		41275: "ṇ",
		41276: "ó",
		41279: "ö",
		41281: "ō",
		41282: "ŏ",
		41283: "ṛ",
		41285: "ś",
		41286: "ṣ",
		41288: "ṭ",
		41289: "ú",
		41291: "ü",
		41292: "ū",
		41293: "ŭ",
		41294: "ÿ",
		41295: "ź",
		41296: "ẓ",
		41301: "ç",
		41303: "‘",
		41310: "ː",
		41311: "ł",
		41313: "ɔ",
		41314: "ø",
		41329: "Á",
		41331: "Ö",
		41334: "Ü",
		41335: "Ā",
		41339: "Ł",
		41340: "Æ",
		41342: "É",
		41505: "Ä",
		41506: "Ś",
		41507: "Ī",
		41508: "Å",
		41515: "Ō",
		41518: "ę",
		41521: "Ẓ",
		41522: "Ḥ",
		41523: "Ṛ",
		41524: "Ṣ",
		41531: "⟨",
		41532: "⟩",
		41542: "Ē",
		41576: "Ç",
		41767: "İ",
	}
}

func (*koujienExtractor) getFontWide() map[int]string {
	return map[int]string{
		41506: "Ś",
		42017: "⇿",
		42018: "🈑",
		42019: "1",
		42021: "2",
		42023: "㊀",
		42024: "㊁",
		42026: "3",
		42027: "❷",
		42028: "❶",
		42029: "〵",
		42030: "〳",
		42031: "❸",
		42034: "4",
		42035: "蒴",
		42036: "〻",
		42037: "❹",
		42038: "5",
		42040: "𣑥",
		42041: "枘",
		42043: "❺",
		42044: "6",
		42045: "❻",
		42046: "棰",
		42047: "栬",
		42048: "7",
		42052: "㊂",
		42053: "垜",
		42054: "桛",
		42055: "糝",
		42056: "佾",
		42057: "❼",
		42058: "埵",
		42061: "挵",
		42063: "癭",
		42065: "閩",
		42067: "窠",
		42069: "鉸",
		42071: "苆",
		42072: "睺",
		42073: "簶",
		42074: "邌",
		42075: "壔",
		42079: "蜱",
		42080: "顗",
		42081: "愷",
		42083: "❽",
		42084: "鸕",
		42086: "氐",
		42089: "壒",
		42092: "鵼",
		42093: "穭",
		42095: "莧",
		42097: "緂",
		42098: "閦",
		42100: "艠",
		42101: "籭",
		42102: "縑",
		42105: "穀",
		42108: "鱝",
		42109: "鈹",
		42273: "蠃",
		42274: "噶",
		42275: "邕",
		42277: "憍",
		42279: "炻",
		42281: "煆",
		42282: "褚",
		42284: "❾",
		42285: "儈",
		42286: "炷",
		42287: "咩",
		42288: "粔",
		42289: "籹",
		42292: "邈",
		42293: "麽",
		42297: "麞",
		42298: "殭",
		42300: "蘞",
		42301: "莔",
		42309: "惲",
		42311: "癋",
		42312: "紇",
		42313: "絁",
		42314: "鏁",
		42315: "枻",
		42316: "儛",
		42317: "櫧",
		42318: "橅",
		42319: "豨",
		42320: "婕",
		42322: "妤",
		42323: "煠",
		42324: "鋂",
		42325: "蜓",
		42326: "袘",
		42329: "鴗",
		42332: "唵",
		42333: "墩",
		42336: "柃",
		42338: "渲",
		42339: "泔",
		42341: "臏",
		42342: "珉",
		42343: "螭",
		42344: "蕙",
		42346: "蘐",
		42347: "棭",
		42348: "朳",
		42349: "尰",
		42350: "賾",
		42351: "竽",
		42352: "裛",
		42353: "孁",
		42354: "闈",
		42356: "簏",
		42358: "箯",
		42360: "蝲",
		42364: "闐",
		42365: "龗",
		42366: "孽",
		42529: "韛",
		42531: "瓫",
		42532: "塼",
		42533: "鄧",
		42535: "杈",
		42537: "緌",
		42538: "顬",
		42540: "銙",
		42542: "頞",
		42544: "❿",
		42546: "𦨞",
		42549: "䳑",
		42551: "藿",
		42552: "璫",
		42553: "稹",
		42554: "跗",
		42555: "縕",
		42556: "幘",
		42557: "繒",
		42558: "蠁",
		42561: "鉏",
		42563: "邶",
		42568: "8",
		42569: "樏",
		42571: "檝",
		42572: "昺",
		42574: "阝",
		42578: "繇",
		42579: "幞",
		42582: "蕤",
		42583: "痤",
		42584: "腊",
		42587: "癤",
		42588: "瓚",
		42591: "熒",
		42592: "鱓",
		42593: "櫲",
		42595: "戕",
		42599: "蚜",
		42600: "嬥",
		42601: "琦",
		42602: "姒",
		42605: "奭",
		42606: "魣",
		42608: "徧",
		42609: "藦",
		42611: "擎",
		42612: "麯",
		42613: "滃",
		42619: "硨",
		42620: "磲",
		42621: "鞚",
		42785: "疿",
		42787: "厓",
		42791: "倻",
		42792: "燄",
		42793: "吒",
		42795: "弇",
		42796: "埿",
		42798: "搩",
		42799: "潙",
		42800: "灤",
		42804: "挹",
		42805: "芎",
		42811: "盌",
		42820: "𩊱",
		42823: "弴",
		42826: "咿",
		42828: "楉",
		42831: "鑯",
		42833: "确",
		42836: "睟",
		42837: "砭",
		42838: "鶍",
		42839: "噯",
		42842: "糕",
		42844: "鴲",
		42846: "藋",
		42847: "嶠",
		42848: "鼯",
		42851: "梲",
		42856: "歆",
		42862: "矪",
		42863: "躃",
		42866: "鯥",
		42868: "芷",
		42871: "糈",
		42873: "鬠",
		42876: "鱏",
		43048: "糗",
		43053: "甪",
		43057: "剡",
		43058: "〽",
		43061: "埦",
		43062: "帔",
		43065: "涪",
		43076: "牁",
		43078: "檞",
		43080: "姧",
		43081: "𤸎",
		43085: "筠",
		43086: "魦",
		43088: "剕",
		43099: "鵂",
		43104: "瑭",
		43106: "喁",
		43107: "堞",
		43108: "佷",
		43109: "繳",
		43110: "熅",
		43111: "梂",
		43112: "斲",
		43113: "痟",
		43114: "兗",
		43118: "榺",
		43119: "儋",
		43120: "橉",
		43121: "鱐",
		43124: "蒺",
		43128: "螈",
		43131: "㡜",
		43133: "臎",
		43134: "鷚",
		43297: "靛",
		43300: "唼",
		43301: "堈",
		43306: "氅",
		43309: "筕",
		43310: "篖",
		43317: "磤",
		43320: "偓",
		43321: "鑊",
		43325: "滇",
		43327: "痀",
		43330: "笯",
		43336: "9",
		43342: "莩",
		43345: "猬",
		43346: "𨫤",
		43349: "蕓",
		43352: "彇",
		43354: "肫",
		43356: "牖",
		43370: "刁",
		43381: "漳",
		43385: "撇",
		43386: "濊",
		43387: "蓯",
		43390: "垸",
		43556: "瘀",
		43557: "槩",
		43568: "閒",
		43575: "牱",
		43582: "蛺",
		43583: "贉",
		43588: "鐖",
		43593: "鑣",
		43594: "堄",
		43595: "蜏",
		43603: "嘷",
		43607: "㊃",
		43611: "⓫",
		43612: "⓬",
		43614: "猨",
		43620: "灬",
		43622: "趍",
		43623: "丨",
		43627: "潝",
		43628: "晳",
		43635: "醅",
		43636: "醞",
		43637: "醮",
		43638: "踠",
		43641: "糏",
		43643: "呫",
		43644: "齭",
		43645: "楲",
		43809: "鱁",
		43810: "鮧",
		43811: "埤",
		43818: "鱮",
		43821: "楨",
		43822: "蔾",
		43824: "螠",
		43825: "跎",
		43826: "熛",
		43827: "貛",
		43829: "鱛",
		43830: "玕",
		43831: "禛",
		43837: "翮",
		43838: "鯇",
		43839: "犰",
		43840: "狳",
		43842: "呍",
		43843: "嚈",
		43845: "魞",
		43846: "噠",
		43848: "蚨",
		43849: "鷀",
		43850: "刖",
		43851: "蝱",
		43854: "窳",
		43855: "粿",
		43860: "賖",
		43870: "藊",
		43876: "翬",
		43883: "暍",
		43886: "頫",
		43889: "菀",
		43899: "╍",
		44071: "烤",
		44073: "昀",
		44079: "齵",
		44093: "襀",
		44100: "▬",
		44101: "阝",
		44102: "乚",
		44113: "罒",
		44121: "嬙",
		44125: "饜",
		44127: "凊",
		44131: "敧",
		44138: "寀",
		44142: "𑖀",
		44144: "觶",
		44321: "芡",
		44330: "鰧",
		44332: "蔯",
		44334: "葈",
		44351: "畯",
		44353: "猍",
		44355: "詃",
		44378: "獐",
		44399: "盹",
		44412: "醃",
		44579: "篨",
		44583: "霂",
		44586: "籧",
		44587: "蜹",
		44613: "趯",
		44620: "輞",
		44626: "喆",
		44628: "鐧",
		44632: "雩",
		44650: "駔",
		44652: "驌",
		44658: "錡",
		44661: "鶹",
		44669: "靮",
		44856: "㉑",
		44857: "㉒",
		44872: "耬",
		44902: "跬",
		44905: "蹢",
		44906: "蹻",
		44909: "栻",
		44910: "煨",
		44919: "獠",
		44922: "嘽",
		44923: "篅",
		44924: "𥫥",
		45089: "矰",
		45091: "脬",
		45092: "箄",
		45094: "鼿",
		45095: "脰",
		45096: "葙",
		45097: "褍",
		45101: "渠",
		45117: "牫",
		45120: "㭬",
		45127: "怍",
		45132: "䲑",
		45137: "嚅",
		45139: "鯘",
		45140: "娌",
		45149: "藛",
		45163: "椱",
		45166: "螵",
		45171: "獦",
		45176: "牕",
		45181: "瘇",
		45182: "幐",
		45350: "棈",
		45351: "鏱",
		45360: "瑇",
		45361: "乀",
		45363: "桕",
		45365: "蛿",
		45366: "盬",
		45367: "鸎",
		45368: "尫",
		45369: "簦",
		45370: "翨",
		45371: "禋",
		45382: "莕",
		45389: "𩺊",
		45391: "勖",
		45392: "璡",
		45393: "璩",
		45395: "杻",
		45397: "媞",
		45403: "薁",
		45404: "簄",
		45405: "磠",
		45411: "鸊",
		45412: "鷉",
		45413: "坧",
		45419: "屟",
		45421: "蛑",
		45434: "柹",
		45435: "蒁",
		45436: "荗",
		45437: "癃",
		45607: "蝤",
		45609: "鱊",
		45615: "坅",
		45616: "檰",
		45617: "餲",
		45619: "洿",
		45628: "啁",
		45639: "繦",
		45640: "誾",
		45652: "灝",
		45670: "猽",
		45674: "蚸",
		45676: "裓",
		45679: "茛",
		45680: "餻",
		45692: "蝘",
		45864: "磈",
		45865: "莘",
		45888: "鰙",
		45889: "卐",
		45890: "♮",
		45891: "吒",
		45894: "𛀁",
		45903: "鱩",
		45917: "齓",
		45932: "荇",
		45934: "鼴",
		45946: "蘡",
		45948: "璘",
		46117: "螇",
		46124: "藂",
		46137: "鰘",
		46161: "耂",
		46162: "牜",
		46163: "㓁",
		46171: "穴",
		46172: "⻗",
		46179: "驓",
		46193: "鱫",
		46194: "鱜",
		46200: "慤",
		46374: "〔",
		46375: "〕",
		46384: "…",
		46390: "①",
		46391: "②",
		46392: "③",
		46393: "④",
		46394: "⑤",
		46395: "⑥",
		46396: "⑦",
		46397: "⑧",
		46398: "⑨",
		46399: "⑩",
		46400: "⑪",
		46401: "⑫",
		46402: "⑬",
		46403: "⑭",
		46404: "⑮",
		46405: "⑯",
		46406: "⑰",
		46407: "⑱",
		46408: "⑲",
		46409: "⑳",
		46420: "⇨",
		46421: "Ⅰ",
		46422: "Ⅱ",
		46425: "Ⅲ",
		46426: "Ⅳ",
		46427: "Ⅾ",
		46433: "𝑨",
		46434: "𝑩",
		46435: "璟",
		46437: "Ⅼ",
		46456: "拼",
		46460: "鍱",
		46626: "灊",
		46640: "玼",
		46654: "涇",
		46656: "潾",
		46658: "泮",
		46661: "𦍛",
		46665: "鯎",
		46666: "𩷏",
		46674: "𦬸",
		46677: "⇀",
		46920: "訇",
		46956: "榷",
		47166: "髁",
		47175: "(季)",
		47183: "Ⓐ",
		47200: "屧",
		47204: "葒",
		47205: "芩",
		47210: "餳",
		47212: "晗",
		47214: "闓",
		47216: "蘄",
		47223: "氳",
		47229: "♨",
		47399: "𠘨",
		47994: "劄",
		50236: "郉",
		51565: "杮",
		52288: "涵",
		52862: "毗",
		55383: "閬",
		56383: "㋐",
		56384: "㋑",
		56385: "㋒",
		56386: "㋓",
		56387: "㋔",
		56388: "㋕",
		56389: "㋖",
		56390: "㋗",
		56391: "㋘",
		56392: "㋙",
		56393: "㋚",
		56394: "㋛",
		56395: "㋜",
		56396: "㋝",
		56397: "㋞",
		56398: "▷",
		56405: "玆",
		56417: "煕",
		60748: "濰",
		61562: "菟",
	}
}
